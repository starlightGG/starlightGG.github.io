<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Assistant - Starlight Games</title>
    
<!-- better global-->
    
    <script src="../js/global.js"></script>
    <script src="../js/settings.js"></script>
    <script id="cloning-script" src="../js/cloner.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

    <style>
        /* --- 1. Soft UI Theme Variables --- */
        :root {
            /* Light Mode Defaults */
            --bg-color: #e0e5ec;
            --text-color: #4a5568;
            --text-secondary: #718096;
            --card-bg: #e0e5ec;
            
            /* Neumorphism Shadows */
            --shadow-light: #ffffff;
            --shadow-dark: #a3b1c6;
            
            /* Accents */
            --primary-color: #4c68ff;
            --user-msg-bg: #4c68ff;
            --user-msg-text: #ffffff;
            --bot-msg-bg: #e0e5ec;
            
            --font-stack: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
        }

        /* Dark Mode Overrides */
        [data-theme="dark"] {
            --bg-color: #292d32;
            --text-color: #e2e8f0;
            --text-secondary: #94a3b8;
            --card-bg: #292d32;
            
            --shadow-light: #353b42;
            --shadow-dark: #1e2125;

            --bot-msg-bg: #292d32;
        }
        
        body {
            font-family: var(--font-stack);
            background-color: var(--bg-color);
            color: var(--text-color);
            margin: 0;
            padding: 20px;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            transition: background 0.3s ease;
        }

        /* --- 2. Main Layout & Container --- */
        .main-wrapper {
            width: 100%;
            max-width: 700px;
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        h2 {
            text-align: center;
            color: var(--primary-color);
            margin-bottom: 10px;
            text-shadow: 1px 1px 2px var(--shadow-dark), -1px -1px 2px var(--shadow-light);
        }

        #chat-container {
            background-color: var(--card-bg);
            border-radius: 20px;
            padding: 20px;
            /* Neumorphic Outset Shadow */
            box-shadow: 
                9px 9px 16px var(--shadow-dark), 
                -9px -9px 16px var(--shadow-light);
            display: flex;
            flex-direction: column;
            height: 600px;
        }

        /* --- 3. Chat Log (Recessed Screen) --- */
        #chat-log {
            flex-grow: 1;
            overflow-y: auto;
            margin-bottom: 20px;
            padding: 20px;
            border-radius: 15px;
            background-color: var(--bg-color);
            
            /* Neumorphic Inset Shadow (Recessed look) */
            box-shadow: 
                inset 6px 6px 12px var(--shadow-dark), 
                inset -6px -6px 12px var(--shadow-light);
        }

        /* Scrollbar Styling */
        #chat-log::-webkit-scrollbar {
            width: 8px;
        }
        #chat-log::-webkit-scrollbar-track {
            background: transparent;
        }
        #chat-log::-webkit-scrollbar-thumb {
            background-color: var(--text-secondary);
            border-radius: 4px;
            opacity: 0.5;
        }

        /* --- 4. Messages --- */
        .message {
            margin-bottom: 15px;
            padding: 12px 18px;
            border-radius: 12px;
            max-width: 80%;
            word-wrap: break-word;
            line-height: 1.5;
            font-size: 0.95em;
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(5px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .user-message {
            margin-left: auto; /* Align right */
            background-color: var(--user-msg-bg);
            color: var(--user-msg-text);
            border-bottom-right-radius: 2px;
            box-shadow: 2px 2px 5px rgba(0,0,0,0.2);
        }

        .bot-message {
            margin-right: auto; /* Align left */
            background-color: var(--bot-msg-bg);
            color: var(--text-color);
            border-bottom-left-radius: 2px;
            border: 1px solid var(--shadow-light);
            /* Small pop-out effect for bot */
            box-shadow: 
                5px 5px 10px var(--shadow-dark), 
                -5px -5px 10px var(--shadow-light);
        }

        /* Markdown Styles inside bot messages */
        .bot-message p { margin: 0 0 10px 0; }
        .bot-message p:last-child { margin-bottom: 0; }
        .bot-message strong { color: var(--primary-color); }
        .bot-message ul { margin: 5px 0; padding-left: 20px; }

        /* --- 5. Input Area --- */
        #user-input {
            display: flex;
            gap: 15px;
        }

        #user-message {
            flex-grow: 1;
            padding: 15px;
            border: none;
            border-radius: 12px;
            background-color: var(--bg-color);
            color: var(--text-color);
            font-family: inherit;
            outline: none;
            
            /* Inset Shadow for Input */
            box-shadow: 
                inset 4px 4px 8px var(--shadow-dark), 
                inset -4px -4px 8px var(--shadow-light);
        }

        #send-button {
            padding: 0 25px;
            background-color: var(--primary-color);
            color: white;
            border: none;
            border-radius: 12px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.2s ease;
            
            /* Outset Shadow */
            box-shadow: 
                5px 5px 10px var(--shadow-dark), 
                -5px -5px 10px var(--shadow-light);
        }

        #send-button:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 
                7px 7px 14px var(--shadow-dark), 
                -7px -7px 14px var(--shadow-light);
        }

        #send-button:active:not(:disabled) {
            transform: translateY(1px);
            box-shadow: inset 2px 2px 5px rgba(0,0,0,0.2);
        }

        #send-button:disabled {
            background-color: var(--text-secondary);
            cursor: not-allowed;
            opacity: 0.7;
        }

        /* --- 6. Footer / Misc --- */
        .disclaimer {
            text-align: center;
            margin-top: 15px;
            font-size: 0.75em;
            color: var(--text-secondary);
        }

        .back-button {
            display: inline-block;
            margin-top: 20px;
            padding: 10px 20px;
            color: var(--text-color);
            text-decoration: none;
            font-weight: bold;
            border-radius: 10px;
            background: var(--card-bg);
            text-align: center;
            
            box-shadow: 
                5px 5px 10px var(--shadow-dark), 
                -5px -5px 10px var(--shadow-light);
            transition: transform 0.2s;
        }
        .back-button:hover {
            transform: translateY(-2px);
            color: var(--primary-color);
        }
    </style>
</head>
<body>

    <script>
        // 1. APPLY THEME IMMEDIATELY (Prevents Flash)
        (function() {
            try {
                const storedTheme = localStorage.getItem('theme');
                if (storedTheme === 'dark') {
                    document.documentElement.setAttribute('data-theme', 'dark');
                }
            } catch (e) {}
        })();
    </script>

    <div class="main-wrapper">
        <h2>Starlight Navigation & Service Assistant</h2>
        
        <div id="chat-container">
            <div id="chat-log">
                <div class="message bot-message">
                    Hello! I'm here to help you navigate Starlight features. Ask me about <strong>Home, Games, Utilities,</strong> or <strong>Settings!</strong>
                </div>
            </div>
            
            <div id="user-input">
                <input type="text" id="user-message" placeholder="Type your message..." autocomplete="off" />
                <button id="send-button">Send</button>
            </div>
            
            <p class="disclaimer">AI can make mistakes. Please check important info.</p>
        </div>

        <a href="/" class="back-button">‚Üê Back to App</a>
    </div>

<script>
    // --- API & Constants ---
    const TOKEN_SERVER_URL = "/txt/token.txt"; 
    const GROQ_API_URL = "https://api.groq.com/openai/v1/chat/completions";
    const GROQ_MODEL = "llama-3.1-8b-instant"; 

    // --- Knowledge Base ---
    const KNOWLEDGE_BASE = `
        You are a helpful assistant for the StarlightGG platform. Your goal is to guide users through the platform's (StarlightGG) navigation and services based *only* on the following information. Use Markdown formatting (like **bolding** or *lists*) in your response to make it clear.

        Home Card: Takes you to the main page, providing an overview of available games, services, or features.
        Games Card: Displays a list of available games, game categories, or a game launcher.
        Utilities Card: Provides access to tools like: chat with the community, owners playlist, computer diagnostics, website status, events for website, and a view full terms button.
        Chatbots Card: Offers interaction with AI-powered chatbots for support, assistance, accessing information, or entertainment.
        Settings Card: Allows configuring account/platform preferences.
        Settings > Page Settings: Customizes the page appearance (e.g., Cloak Type, Background Pattern).
        Settings > Card Cloaker Presets: Options include Clever | Portal, StarlightGG (Default), Khan Academy, Outlook Mail, Calculator, Activate Learning, Gallopade, IL Classroom, Zearn, iCivics, Pear Assessment, Google Drive, or Google Docs.
        
        LIABILITY WAIVER: If the user asks about liability, terms, or the creator/owner's responsibility, use this exact statement: "LIABILITY WAIVER: You agree that the creator/owner of Starlight Games assumes NO LIABILITY for your actions. You agree to hold the owner harmless from any claims, damages, or legal/disciplinary actions resulting from your use of the Service."
        
        Do not provide information outside of this knowledge base. Keep your answers concise and directly relevant to the user's question. If they're off topic, please tell them to stay on topic or go to Chatbots Card and ask the same request there. (If urgent, provide info even if offtopic.) If you don't know if its off topic, just say you dont have info on what they're talking about 
    `;

    // --- DOM Elements ---
    const chatLog = document.getElementById('chat-log');
    const userMessageInput = document.getElementById('user-message');
    const sendButton = document.getElementById('send-button');

    // --- State ---
    let conversationHistory = [{ role: "system", content: KNOWLEDGE_BASE }];

    // --- Event Listeners ---
    sendButton.addEventListener('click', sendMessage);
    userMessageInput.addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            sendMessage();
        }
    });

    /**
     * Parses the retry time from the Groq error message.
     */
    function getRetryTime(errorMessage) {
        const match = errorMessage.match(/Please try again in ([0-9]+\.[0-9]+s)/);
        if (match && match[1]) {
            return match[1];
        }
        return "a moment"; 
    }

    /**
     * Main Async Logic to Handle Messaging
     */
    async function sendMessage() {
        const userMessageText = userMessageInput.value.trim();
        if (!userMessageText) return;

        // 1. Display User Message
        appendMessage(userMessageText, 'user-message', false);
        userMessageInput.value = '';
        sendButton.disabled = true;
        conversationHistory.push({ role: "user", content: userMessageText });

        try {
            // 2. Dynamic Token Fetching
            let apiKey;
            try {
                const tokenResponse = await fetch(TOKEN_SERVER_URL);
                if (!tokenResponse.ok) throw new Error(`Status: ${tokenResponse.status}`);
                
                let rawKey = (await tokenResponse.text()).trim();
                rawKey = atob(rawKey); // Decode
                apiKey = `gsk_${rawKey}`;
                
                if (!rawKey || rawKey.length < 10) throw new Error("Invalid token.");

            } catch (tokenError) {
                console.error("Token Error:", tokenError);
                throw new Error("TokenFetchFailed");
            }

            // 3. API Request to Groq
            const response = await fetch(GROQ_API_URL, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${apiKey}` 
                },
                body: JSON.stringify({
                    model: GROQ_MODEL,
                    messages: conversationHistory,
                    temperature: 0.7 
                })
            });

            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(errorData.error.message || response.statusText);
            }

            const data = await response.json();
            const botResponseText = data.choices[0].message.content;

            // 4. Display Bot Message
            appendMessage(botResponseText, 'bot-message', true);
            conversationHistory.push({ role: "assistant", content: botResponseText });

        } catch (error) {
            console.error("Chat Error:", error);
            
            let simplifiedMessage = `[ERROR] Failed to get response.`;
            
            if (error.message.includes("Rate limit")) {
                const retryTime = getRetryTime(error.message);
                simplifiedMessage = `Rate limit reached. Please try again in: **${retryTime}**`;
            } else if (error.message === "TokenFetchFailed") {
                 simplifiedMessage = `[ERROR] Could not connect to the security server. Please try again later.`;
            }
            
            appendMessage(simplifiedMessage, 'bot-message', true);
            conversationHistory.pop(); // Remove failed message from history
        } finally {
            sendButton.disabled = false;
            // Focus back on input for better UX
            userMessageInput.focus();
        }
    }

    /**
     * Appends a message to the chat log
     */
    function appendMessage(text, className, isMarkdown) {
        const messageDiv = document.createElement('div');
        messageDiv.classList.add('message', className);
        
        if (isMarkdown && typeof marked !== 'undefined') {
            messageDiv.innerHTML = marked.parse(text); 
        } else {
            messageDiv.textContent = text;
        }
        
        chatLog.appendChild(messageDiv);
        chatLog.scrollTop = chatLog.scrollHeight;
    }
</script>

</body>
</html>
