<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Real-Time Performance Monitor</title>
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    
    <style>
        /* --- 1. CSS Variables for Soft UI Theme --- */
        :root {
            /* Light Mode Defaults */
            --bg-color: #e0e5ec;
            --text-color: #4a5568;
            --text-secondary: #8892a0;
            --card-bg: #e0e5ec;
            
            /* Neumorphism Shadows - Light */
            --shadow-light: #ffffff;
            --shadow-dark: #a3b1c6;
            
            /* Accents */
            --accent-primary: #00bcd4;
            --border-color: #cbd5e0;

            /* Status Colors */
            --status-good: #4CAF50;
            --status-warn: #FFC107;
            --status-poor: #F44336;

            /* Grade Gradients */
            --grade-s: linear-gradient(135deg, #FFD700, #FFA500);
            --grade-a: linear-gradient(135deg, #00C9FF, #92FE9D);
            --grade-b: linear-gradient(135deg, #a8ff78, #78ffd6);
            --grade-c: linear-gradient(135deg, #fce38a, #f38181);
            --grade-d: linear-gradient(135deg, #ff9966, #ff5e62);
            --grade-f: linear-gradient(135deg, #556270, #ff6b6b);
        }

        /* Dark Mode Overrides */
        [data-theme="dark"] {
            --bg-color: #292d32;
            --text-color: #e2e8f0;
            --text-secondary: #94a3b8;
            --card-bg: #292d32;
            
            /* Neumorphism Shadows - Dark */
            --shadow-light: #353b42;
            --shadow-dark: #1e2125;
            
            --accent-primary: #00bcd4;
            --border-color: #444;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            margin: 0;
            padding: 20px;
            transition: background 0.3s ease, color 0.3s ease;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 30px;
            background-color: var(--card-bg);
            border-radius: 20px;
            /* Soft Container Shadow */
            box-shadow: 
                8px 8px 16px var(--shadow-dark), 
                -8px -8px 16px var(--shadow-light);
        }

        h1 {
            color: var(--accent-primary);
            border-bottom: 2px solid var(--border-color);
            padding-bottom: 15px;
            margin-top: 0;
            text-shadow: 1px 1px 2px var(--shadow-dark), -1px -1px 2px var(--shadow-light);
        }

        h2 {
            color: var(--text-secondary);
            margin-top: 35px;
            font-size: 1.1em;
            letter-spacing: 0.5px;
        }

        /* --- Grade Card Section --- */
        .grade-container {
            display: flex;
            justify-content: center;
            margin-bottom: 40px;
        }

        .grade-card {
            background-color: var(--card-bg);
            padding: 30px;
            border-radius: 20px;
            text-align: center;
            width: 100%;
            max-width: 600px;
            box-shadow: 
                inset 5px 5px 10px var(--shadow-dark), 
                inset -5px -5px 10px var(--shadow-light);
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .grade-circle {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 4em;
            font-weight: 800;
            margin-bottom: 15px;
            color: #fff;
            background: var(--text-secondary); /* Default gray while calibrating */
            box-shadow: 
                5px 5px 10px var(--shadow-dark), 
                -5px -5px 10px var(--shadow-light);
            text-shadow: 2px 2px 4px rgba(0,0,0,0.2);
            transition: background 0.5s ease;
        }

        .grade-note-title {
            font-size: 1.2em;
            font-weight: bold;
            color: var(--text-color);
            margin-bottom: 5px;
        }

        .grade-note-text {
            font-size: 1em;
            color: var(--text-secondary);
            font-style: italic;
            max-width: 80%;
        }
        
        .retry-btn {
            margin-top: 20px;
            padding: 10px 20px;
            border: none;
            border-radius: 12px;
            background: var(--accent-primary);
            color: white;
            font-weight: bold;
            cursor: pointer;
            box-shadow: 4px 4px 8px var(--shadow-dark), -4px -4px 8px var(--shadow-light);
            display: none;
        }

        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 25px;
            margin: 30px 0;
        }

        /* --- Soft UI Cards --- */
        .metric-card {
            background-color: var(--card-bg);
            padding: 20px;
            border-radius: 16px;
            text-align: center;
            border: 1px solid transparent; /* Prevents layout shift */
            
            /* The Neumorphic Effect */
            box-shadow: 
                6px 6px 12px var(--shadow-dark), 
                -6px -6px 12px var(--shadow-light);
            
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }

        .metric-card:hover {
            transform: translateY(-3px);
            /* Deeper shadow on hover */
            box-shadow: 
                8px 8px 16px var(--shadow-dark), 
                -8px -8px 16px var(--shadow-light);
        }

        .metric-card h2 {
            margin: 0 0 8px 0;
            font-size: 0.95em;
            color: var(--accent-primary);
            font-weight: 700;
        }

        .metric-card h3 {
            margin: 0 0 15px 0;
            font-size: 0.75em;
            color: var(--text-secondary);
            font-weight: normal;
            height: 30px; 
            line-height: 1.4;
        }

        .metric-card p {
            font-size: 2em;
            font-weight: bold;
            margin: 5px 0;
            /* Inset text effect for values */
            text-shadow: 1px 1px 1px var(--shadow-light), -1px -1px 1px var(--shadow-dark);
        }
        
        .chart-container {
            width: 100%;
            max-height: 400px;
            padding: 20px;
            border-radius: 16px;
            background-color: var(--card-bg);
            /* Inset Shadow for Chart Well */
            box-shadow: 
                inset 5px 5px 10px var(--shadow-dark), 
                inset -5px -5px 10px var(--shadow-light);
            box-sizing: border-box;
        }

        hr { border: 0; border-top: 1px solid var(--border-color); margin: 40px 0; }

        /* Custom Colors for JS status updates */
        .good { color: var(--status-good); }
        .needs-improvement { color: var(--status-warn); }
        .poor { color: var(--status-poor); }
        .pass { color: var(--status-good); }
        .fail { color: var(--status-poor); }

        /* --- New Utilities Section Styles --- */
        .tools-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 20px;
            margin-bottom: 40px;
        }

        .tool-btn {
            background-color: var(--card-bg);
            color: var(--text-color);
            padding: 15px;
            border: none;
            border-radius: 12px;
            font-size: 1em;
            font-weight: bold;
            cursor: pointer;
            box-shadow: 6px 6px 12px var(--shadow-dark), -6px -6px 12px var(--shadow-light);
            transition: transform 0.1s ease, box-shadow 0.1s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .tool-btn:hover {
            color: var(--accent-primary);
            transform: translateY(-2px);
        }

        .tool-btn:active {
            box-shadow: inset 4px 4px 8px var(--shadow-dark), inset -4px -4px 8px var(--shadow-light);
            transform: translateY(0);
        }

        /* --- Modal Styles --- */
        .modal-overlay {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.5);
            backdrop-filter: blur(5px);
            z-index: 1000;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s ease;
        }

        .modal-overlay.active {
            opacity: 1;
            pointer-events: all;
        }

        .modal-card {
            background: var(--card-bg);
            padding: 30px;
            border-radius: 20px;
            width: 90%;
            max-width: 500px;
            box-shadow: 8px 8px 16px var(--shadow-dark), -8px -8px 16px var(--shadow-light);
            text-align: center;
            position: relative;
        }

        .close-modal {
            position: absolute;
            top: 15px;
            right: 20px;
            font-size: 1.5em;
            cursor: pointer;
            color: var(--text-secondary);
        }

        .test-display-area {
            background: var(--bg-color);
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
            min-height: 100px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            box-shadow: inset 4px 4px 8px var(--shadow-dark), inset -4px -4px 8px var(--shadow-light);
            overflow: hidden;
        }
        
        .big-text { font-size: 3em; font-weight: bold; color: var(--accent-primary); }
        .med-text { font-size: 1.5em; color: var(--text-color); }
        
        .scroll-track {
            height: 200px;
            overflow-y: scroll;
            width: 100%;
            border: 1px solid var(--border-color);
        }
        .scroll-content {
            height: 200000px;
            background: linear-gradient(to bottom, var(--accent-primary), transparent);
        }
    </style>
</head>
<body>
    
    <script>
        // 1. APPLY THEME IMMEDIATELY (Before content renders)
        (function() {
            try {
                const storedTheme = localStorage.getItem('theme');
                if (storedTheme === 'dark') {
                    document.documentElement.setAttribute('data-theme', 'dark');
                } else {
                    document.documentElement.removeAttribute('data-theme');
                }
            } catch (e) { console.log("LocalStorage access denied"); }
        })();
    </script>

    <div class="container">
        <h1>üöÄ Real-Time Web Performance</h1>
        
        <!-- Overall Grade Section -->
        <div class="grade-container">
            <div class="grade-card">
                <div class="grade-circle" id="grade-circle">...</div>
                <div class="grade-note-title" id="grade-title">Calibrating System...</div>
                <div class="grade-note-text" id="grade-note">Please wait 7 seconds while we benchmark your device.</div>
                <button id="retry-btn" class="retry-btn" onclick="restartBenchmark()">Reattempt Benchmark</button>
            </div>
        </div>

        <div class="metrics-grid">
            <div class="metric-card">
                <h2>FCP</h2>
                <h3>First Contentful Paint</h3>
                <p id="fcp-value">Measuring...</p>
            </div>
            <div class="metric-card">
                <h2>LCP</h2>
                <h3>Largest Contentful Paint</h3>
                <p id="lcp-value">Measuring...</p>
            </div>
            <div class="metric-card">
                <h2>INP</h2>
                <h3>Interaction Latency</h3>
                <p id="inp-value">Measuring...</p>
            </div>
            <div class="metric-card">
                <h2>FPS</h2>
                <h3>Frames Per Second</h3>
                <p id="fps-value">Measuring...</p>
            </div>
            <div class="metric-card">
                <h2>Ping</h2>
                <h3>Network Latency</h3>
                <p id="ping-value">Measuring...</p>
            </div>
            <div class="metric-card">
                <h2>DCL</h2>
                <h3>DOM Content Loaded</h3>
                <p id="dcl-value">Measuring...</p>
            </div>
            <div class="metric-card">
                <h2>Storage</h2>
                <h3>Local Storage Access</h3>
                <p id="local-storage-status">Running...</p>
            </div>
            <div class="metric-card">
                <h2>WASM</h2>
                <h3>WebAssembly Support</h3>
                <p id="wasm-support-status">Running...</p>
            </div>
        </div>

        <hr>

        <!-- New System Utilities Section -->
        <h2>System Utilities</h2>
        <div class="tools-grid">
            <button class="tool-btn" onclick="openTest('keyboard')">‚å®Ô∏è Keyboard Tester</button>
            <button class="tool-btn" onclick="openTest('scroll')">üìú Scroll Speed</button>
            <button class="tool-btn" onclick="openTest('stress')">üî• Stress Test</button>
            <button class="tool-btn" onclick="openTest('cps')">‚ö° CPS Test</button>
        </div>

        <hr>

        <h2>Key Load Timings</h2>
        <div class="chart-container">
            <canvas id="performanceChart"></canvas>
        </div>
    </div>

    <!-- Generic Modal Overlay -->
    <div id="modal-overlay" class="modal-overlay">
        <div class="modal-card">
            <div class="close-modal" onclick="closeModal()">√ó</div>
            <h2 id="modal-title" style="margin-top:0">Test Title</h2>
            <div id="modal-body"></div>
        </div>
    </div>
    
    <script>
        // Helper: Get CSS variable value for Chart colors
        function getCssVar(name) {
            return getComputedStyle(document.body).getPropertyValue(name).trim();
        }

        // Function to format milliseconds
        function formatTime(ms) {
            if (ms < 1000) return `${ms.toFixed(0)} ms`;
            return `${(ms / 1000).toFixed(2)} s`;
        }

        // Function to update metric cards
        function updateMetric(id, value, type) {
            const element = document.getElementById(id);
            if (!element) return;

            let colorClass = 'needs-improvement'; 
            
            if (type === 'paint') { // FCP/LCP
                if (value <= 1800) { colorClass = 'good'; } 
                else if (value <= 2500) { colorClass = 'needs-improvement'; } 
                else { colorClass = 'poor'; }
                element.textContent = formatTime(value);

                // Update State for Grade
                if (id === 'lcp-value') systemState.lcp = value;

            } else if (type === 'dcl') { // DCL
                element.textContent = formatTime(value);
            } else if (type === 'inp') { // INP
                if (value <= 200) { colorClass = 'good'; } 
                else if (value <= 500) { colorClass = 'needs-improvement'; } 
                else { colorClass = 'poor'; }
                element.textContent = formatTime(value);

                // Update Chart for INP
                const idx = chartData.labels.indexOf('INP');
                if (idx !== -1) {
                    chartData.timing[idx] = value;
                    drawChart();
                }
            } else if (type === 'fps') { // FPS
                const fpsValue = parseFloat(value);
                if (fpsValue >= 55) { colorClass = 'good'; } 
                else if (fpsValue >= 30) { colorClass = 'needs-improvement'; } 
                else { colorClass = 'poor'; }
                element.textContent = `${fpsValue.toFixed(0)} FPS`;

                // Update State for Grade
                systemState.fps = fpsValue;

            } else if (type === 'ping') { // Ping
                const pingValue = parseFloat(value);
                if (pingValue <= 50) { colorClass = 'good'; } 
                else if (pingValue <= 150) { colorClass = 'needs-improvement'; } 
                else { colorClass = 'poor'; }
                element.textContent = `${pingValue.toFixed(0)} ms`;

                // Update State for Grade
                systemState.ping = pingValue;

            } else if (type === 'passfail') { // Local Storage / WASM
                if (value === 'PASS') { colorClass = 'pass'; }
                else { colorClass = 'fail'; }
                element.textContent = value;
            }

            element.className = ''; 
            element.classList.add(colorClass);
        }

        // Global array to store chart data
        const chartData = {
            labels: [],
            timing: [],
        };

        // Initialize and draw the chart
        function drawChart() {
            const ctx = document.getElementById('performanceChart').getContext('2d');
            
            if (window.myPerformanceChart) {
                window.myPerformanceChart.destroy();
            }

            // Get current theme colors for the chart
            const textColor = getCssVar('--text-color');
            const gridColor = getCssVar('--border-color');

            window.myPerformanceChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: chartData.labels,
                    datasets: [{
                        label: 'Load Timing (ms)',
                        data: chartData.timing,
                        backgroundColor: [
                            'rgba(75, 192, 192, 0.6)', 
                            'rgba(255, 159, 64, 0.6)', 
                            'rgba(153, 102, 255, 0.6)',
                            'rgba(255, 99, 132, 0.6)'
                        ],
                        borderColor: [
                            'rgba(75, 192, 192, 1)',
                            'rgba(255, 159, 64, 1)',
                            'rgba(153, 102, 255, 1)',
                            'rgba(255, 99, 132, 1)' 
                        ],
                        borderWidth: 1,
                        borderRadius: 5, // Soft edges on bars
                        barThickness: 50
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            grid: { color: gridColor, drawBorder: false },
                            ticks: { color: textColor },
                            title: {
                                display: true,
                                text: 'Milliseconds (ms)',
                                color: getCssVar('--text-secondary')
                            }
                        },
                        x: {
                            grid: { display: false },
                            ticks: { color: textColor }
                        }
                    },
                    plugins: {
                        legend: { display: false },
                        title: { display: false }
                    }
                }
            });
        }

        // --- 1. Measure FCP, LCP, DCL ---
        function measurePaintAndLoadMetrics() {
            const observer = new PerformanceObserver((list) => {
                let lcpTime = 0;
                
                list.getEntries().forEach(entry => {
                    if (entry.name === 'first-contentful-paint') {
                        const fcp = entry.startTime;
                        updateMetric('fcp-value', fcp, 'paint');
                        
                        chartData.labels.push('FCP');
                        chartData.timing.push(fcp);
                    }
                    
                    if (entry.entryType === 'largest-contentful-paint') {
                        lcpTime = entry.startTime;
                    }
                });
                
                if (lcpTime > 0) {
                    updateMetric('lcp-value', lcpTime, 'paint');
                    
                    if (!chartData.labels.includes('LCP')) {
                        chartData.labels.push('LCP');
                        chartData.timing.push(lcpTime);
                    }
                    observer.disconnect();
                    
                    const dclTime = performance.timing.domContentLoadedEventEnd - performance.timing.navigationStart;
                    updateMetric('dcl-value', dclTime, 'dcl');
                    
                    if (!chartData.labels.includes('DCL')) {
                        chartData.labels.push('DCL');
                        chartData.timing.push(dclTime);
                    }
                    
                    drawChart();
                }
            });

            observer.observe({ type: 'paint', buffered: true });
            observer.observe({ type: 'largest-contentful-paint', buffered: true });
        }


        // --- 2. Measure INP ---
        function measureInteractionMetrics() {
            let maxInp = 0;

            const observer = new PerformanceObserver((list) => {
                list.getEntries().forEach(entry => {
                    // Fallback to duration if interactionId isn't fully supported yet
                    const interactionTime = entry.duration;
                    if (interactionTime > maxInp) {
                        maxInp = interactionTime;
                        updateMetric('inp-value', maxInp, 'inp');
                    }
                });
            });

            try {
                observer.observe({
                    type: 'event',
                    buffered: true,
                    durationThreshold: 16 
                });
            } catch (e) { /* INP not supported in all browsers yet */ }
        }

        // --- 3. Measure FPS ---
        function measureFPS() {
            const times = [];
            function refreshLoop() {
                window.requestAnimationFrame(() => {
                    const now = performance.now();
                    while (times.length > 0 && times[0] <= now - 1000) {
                        times.shift();
                    }
                    times.push(now);
                    const fps = times.length;
                    updateMetric('fps-value', fps, 'fps');
                    refreshLoop(); 
                });
            }
            refreshLoop(); 
        }
        
        // --- 4. Measure Ping ---
        async function measurePing() {
            // Keep original logic, but check finalized state
            if (isGradeFinalized) return; 

            const startTime = performance.now();
            
            try {
                // Using no-cors mode since we only care about the timing of the response, not the content
                await fetch(`https://connectivitycheck.gstatic.com/generate_204?t=${Date.now()}`, { 
                    mode: 'no-cors',
                    cache: 'no-store'
                });
                
                const endTime = performance.now();
                updateMetric('ping-value', endTime - startTime, 'ping');
            } catch (e) {
                document.getElementById('ping-value').textContent = 'Error';
                document.getElementById('ping-value').className = 'poor';
            }
            
            pingTimeout = setTimeout(measurePing, 2000); 
        }

        // --- Grade Logic ---
        let systemState = { fps: 0, ping: 0, lcp: 0 };
        let isGradeFinalized = false;
        let benchmarkTimer; 
        let pingTimeout;

        function updateGradeUI(percentage) {
            const circle = document.getElementById('grade-circle');
            const title = document.getElementById('grade-title');
            const note = document.getElementById('grade-note');

            // Notes arrays
            const sNotes = [
                "NASA called, they want their supercomputer back.", 
                "Is this running on alien technology?", 
                "Overkill. Absolute overkill.",
                "It renders the future before it happens.",
                "Too fast for human eyes.",
                "Did you steal this from Area 51?",
                "Calculating the last digit of Pi...",
                "Warning: Approaching light speed.",
                "Gabe Newell would be proud.",
                "You could run the entire matrix on this.",
                "I didn't know browsers could go this fast.",
                "Are you the mainframe?",
                "This performance is actually illegal in 3 countries.",
                "Physics laws are being violated right now.",
                "Zero latency, zero problems.",
                "You must be the admin.",
                "Compiling the universe...",
                "Wait, did you download more RAM?",
                "My logic circuits are blown away.",
                "Simply perfection."
            ];
            const aNotes = [
                "Buttery smooth. You definitely have RGB lighting.", 
                "Zoom zoom! Everything is loading instantly.", 
                "Runs Crysis? Probably.",
                "Ready for that 360 no-scope.",
                "I can feel the frames washing over me.",
                "Your K/D ratio just went up.",
                "Is it cold in here? Oh, it's just your liquid cooling.",
                "Show off.",
                "High performance detected. Nice setup, bro.",
                "This rig is ready for 8K gaming.",
                "Loading screens are a thing of the past for you.",
                "Silky smooth experience.",
                "Does your PC lift? Because it's strong.",
                "Impressive specs you got there.",
                "No lag, just frag.",
                "Pixel perfect performance.",
                "Everything is instant. As it should be.",
                "You definitely built this yourself.",
                "Top tier experience.",
                "Blazing fast."
            ];
            const bNotes = [
                "Solid workhorse. Reliable like a Toyota.", 
                "Good enough for government work.", 
                "Not bad. Not great, but not bad.",
                "It ain't much, but it's honest work.",
                "Does the job without complaining.",
                "Perfectly balanced, as all things should be.",
                "Perfect for spreadsheets and light gaming.",
                "Respectable. No shame in this game.",
                "Reliable. Dependable. Sturdy.",
                "Gets the job done.",
                "Standard issue performance.",
                "Not winning races, but finishing them.",
                "A decent daily driver.",
                "Runs smooth enough.",
                "Meets the requirements.",
                "Better than most.",
                "Solid B. Asian parents disappointed, but I'm proud.",
                "Working as intended.",
                "Steady performance.",
                "No major complaints here."
            ];
            const cNotes = [
                "Average potato. Good for mashed potatoes.", 
                "Have you tried downloading more RAM?", 
                "Meh. It loads eventually.",
                "I think I heard the fan scream.",
                "Don't open Android Studio, I beg you.",
                "Good for solitaire.",
                "It's trying so hard right now.",
                "Patience is a virtue.",
                "It works, just don't try to open more than 3 tabs.",
                "Maybe close a few windows?",
                "Struggling a bit there, buddy.",
                "It's not fast, but it's yours.",
                "Budget cuts hit hard.",
                "Running a bit warm today?",
                "I've seen faster, but I've seen worse.",
                "Mediocre at best.",
                "Just enough to browse Reddit.",
                "Don't push it.",
                "Careful with that scroll wheel.",
                "Loading... please wait."
            ];
            const dNotes = [
                "It runs, but at what cost?", 
                "Please don't explode.", 
                "Do you smell smoke?", 
                "Struggling to breathe.",
                "I can smell burning plastic.",
                "Is there a hamster inside running?",
                "FPS? You mean Seconds Per Frame?",
                "Don't click anything too fast.",
                "I'm tired boss.",
                "System request: Please kill me.",
                "Turning the fan to max speed...",
                "Visual stutter detected.",
                "Input lag is real.",
                "Why are you doing this to me?",
                "I think it's crying.",
                "Thermal throttling imminent.",
                "Barely hanging on.",
                "It's a struggle bus.",
                "Sending distress signal.",
                "Critical condition."
            ];
            const fNotes = [
                "Bro, are you running this on a smart fridge?", 
                "Is your internet delivered by carrier pigeon?", 
                "Loading... forever...",
                "Just throw it in the river.",
                "My microwave has more processing power.",
                "Are you mining bitcoin on a blackberry?",
                "This belongs in a museum.",
                "Is this a prank?",
                "Error 404: Speed not found.",
                "I hope you have patience. A lot of it.",
                "My calculator is faster than this.",
                "Is this a PowerPoint presentation?",
                "Hardware from the stone age.",
                "Did you find this in a dumpster?",
                "Upgrade recommended. Immediately.",
                "It's dead, Jim.",
                "A literal potato with wires.",
                "I'm surprised it turned on.",
                "Connection via tin can and string.",
                "Game over."
            ];
            
            // Random Titles arrays
            const sTitles = [
                "NASA Supercomputer", "Quantum Computer", "God Tier", "Overclocked Beast",
                "Infinity Processor", "Time Traveler", "Light Speed", "Over 9000", 
                "Server Grade", "Developer Rig", "Silicon Lottery Winner", "Future Tech", 
                "Unreal Engine 5 Ready", "Simulation Breaker", "Quantum Core", "Neural Net Host", 
                "AI Overlord", "Bitcoin Miner Extreme", "Cold Fusion Powered", "The Mainframe"
            ];
            const aTitles = [
                "Gaming Beast", "High End Rig", "Speed Demon", "Frames Win Games",
                "Pro Gamer", "Streamer Spec", "High Refresh Rate", "Ultra Settings", 
                "Ray Tracing On", "Liquid Cooled", "RGB Everything", "Master Race", 
                "Flagship Killer", "Top Tier", "Butter Smooth", "No Lag Allowed",
                "Elite Machine", "Performance King", "Hyper Speed", "Turbo Charged"
            ];
            const bTitles = [
                "Solid Workhorse", "Reliable Machine", "Good Enough", "Office Champion",
                "Reliable Daily", "Office Hero", "Student Special", "Decent Rig", 
                "Mid-Range King", "Budget Beast", "Bang for Buck", "Dependable", 
                "Work From Home", "Casual Gamer", "1080p Warrior", "Standard Issue",
                "The Regular", "Middle Class", "Steady Ed", "Consistent"
            ];
            const cTitles = [
                "Average Potato", "Budget Build", "Chromebook Tier", "It Runs Doom",
                "Chromebook Pro", "Budget Laptop", "Homework Machine", "Browser Warrior", 
                "Slow & Steady", "Fan Noise Loud", "Thermal Throttling", "Economy Class", 
                "Entry Level", "Minimum Specs", "Lag Spike City", "Loading...", 
                "Buffering...", "Old Faithful", "The Minimum", "Basic Tier"
            ];
            const dTitles = [
                "Survival Mode", "Barely Alive", "Potato Light", "Glitchy Mess",
                "Toaster Pro", "Calculator Plus", "Smart Watch CPU", "Hamster Powered", 
                "Potato Battery", "Glitch Mob", "Frame Dropper", "Slide Show", 
                "Lag Machine", "Blue Screen Risk", "Overheating...", "Help Me",
                "Struggle Bus", "Crash Prone", "Slow Motion", "Laggy Boi"
            ];
            const fTitles = [
                "Toaster Edition", "Smart Fridge", "Potato Powered", "Hamster Wheel",
                "Abacus", "Rock with Wires", "Paperweight", "Antique Roadshow", 
                "Fossil", "404 Performance Not Found", "Dial-Up Era", "Wood PC", 
                "Potato", "Brick", "Doorstop", "Calculator",
                "Vegetable", "Scrap Metal", "Dinosaur", "Ancient Relic"
            ];

            const pick = (arr) => arr[Math.floor(Math.random() * arr.length)];

            let grade, bg, titleText, noteText;

            if (percentage >= 95) { 
                grade = 'S'; 
                bg = 'var(--grade-s)'; 
                titleText = pick(sTitles); 
                noteText = pick(sNotes); 
            }
            else if (percentage >= 85) { 
                grade = 'A'; 
                bg = 'var(--grade-a)'; 
                titleText = pick(aTitles); 
                noteText = pick(aNotes); 
            }
            else if (percentage >= 70) { 
                grade = 'B'; 
                bg = 'var(--grade-b)'; 
                titleText = pick(bTitles); 
                noteText = pick(bNotes); 
            }
            else if (percentage >= 55) { 
                grade = 'C'; 
                bg = 'var(--grade-c)'; 
                titleText = pick(cTitles); 
                noteText = pick(cNotes); 
            }
            else if (percentage >= 40) { 
                grade = 'D'; 
                bg = 'var(--grade-d)'; 
                titleText = pick(dTitles); 
                noteText = pick(dNotes); 
            }
            else { 
                grade = 'F'; 
                bg = 'var(--grade-f)'; 
                titleText = pick(fTitles); 
                noteText = pick(fNotes); 
            }

            if (systemState.fps < 15 && systemState.fps > 0) noteText = "It's a slideshow. Is your graphics card made of wood?";

            circle.textContent = grade;
            circle.style.background = bg;
            title.textContent = titleText;
            note.textContent = noteText;
            document.getElementById('retry-btn').style.display = 'inline-block';
        }

        function finalizeBenchmark() {
            if (isGradeFinalized) return;
            isGradeFinalized = true;

            let score = 0, maxScore = 0;
            
            // FPS (50 pts)
            maxScore += 50;
            if (systemState.fps >= 58) score += 50;
            else if (systemState.fps >= 50) score += 45;
            else if (systemState.fps >= 30) score += 30;
            else if (systemState.fps >= 15) score += 10;

            // Ping (30 pts)
            maxScore += 30;
            if (systemState.ping > 0) {
                if (systemState.ping < 40) score += 30;
                else if (systemState.ping < 80) score += 20;
                else if (systemState.ping < 150) score += 10;
            } else { score += 20; } // Neutral if ping fails

            // LCP (20 pts)
            maxScore += 20;
            if (systemState.lcp === 0) score += 20; // Assume good
            else {
                if (systemState.lcp < 1200) score += 20;
                else if (systemState.lcp < 2500) score += 15;
                else if (systemState.lcp < 4000) score += 5;
            }

            updateGradeUI((score / maxScore) * 100);

            // --- Add FPS and Ping to Chart ---
            // Only add if they aren't already there to prevent duplicates on potential re-runs
            if (!chartData.labels.includes('FPS')) {
                chartData.labels.push('FPS');
                chartData.timing.push(systemState.fps);
            }
            if (!chartData.labels.includes('Ping')) {
                chartData.labels.push('Ping');
                chartData.timing.push(systemState.ping);
            }
            drawChart();
        }

        function restartBenchmark() {
            isGradeFinalized = false;
            
            // Clear any existing timers to prevent overlaps
            if (benchmarkTimer) clearTimeout(benchmarkTimer);
            if (pingTimeout) clearTimeout(pingTimeout);

            document.getElementById('grade-circle').textContent = '...';
            document.getElementById('grade-circle').style.background = 'var(--text-secondary)';
            document.getElementById('grade-title').textContent = 'Calibrating System...';
            document.getElementById('grade-note').textContent = 'Please wait 7 seconds while we benchmark...';
            document.getElementById('retry-btn').style.display = 'none';
            systemState = { fps: 0, ping: 0, lcp: 0 };
            
            benchmarkTimer = setTimeout(finalizeBenchmark, 7000);
            measurePing(); // Restart ping
        }

        // --- Handle Tab Visibility ---
        document.addEventListener('visibilitychange', () => {
            if (document.hidden) {
                // User clicked off: pause benchmark timer so it doesn't fail in background
                if (benchmarkTimer) clearTimeout(benchmarkTimer);
            } else {
                // User came back: restart benchmark if we haven't finished yet
                if (!isGradeFinalized) {
                    restartBenchmark();
                }
            }
        });

        // --- 5. Functionality Checks ---

        // Local Storage Test
        function runLocalStorageTest() {
            const testKey = '__test_key__';
            const testValue = 'success';
            try {
                localStorage.setItem(testKey, testValue);
                const retrievedValue = localStorage.getItem(testKey);
                localStorage.removeItem(testKey);
                if (retrievedValue === testValue) {
                    updateMetric('local-storage-status', 'PASS', 'passfail');
                } else {
                    updateMetric('local-storage-status', 'FAIL', 'passfail');
                }
            } catch (e) {
                updateMetric('local-storage-status', 'FAIL', 'passfail');
            }
        }
        
        // WebAssembly Support Test
        function runWasmSupportTest() {
            if (typeof WebAssembly !== 'object' || WebAssembly === null) {
                updateMetric('wasm-support-status', 'FAIL', 'passfail');
                return;
            }
            try {
                const module = new WebAssembly.Module(new Uint8Array([0x00, 0x61, 0x73, 0x6d, 0x01, 0x00, 0x00, 0x00]));
                if (module instanceof WebAssembly.Module) {
                    updateMetric('wasm-support-status', 'PASS', 'passfail');
                } else {
                    updateMetric('wasm-support-status', 'FAIL', 'passfail');
                }
            } catch (e) {
                updateMetric('wasm-support-status', 'FAIL', 'passfail');
            }
        }

        // --- 6. UTILITIES LOGIC ---
        
        const modal = document.getElementById('modal-overlay');
        const modalTitle = document.getElementById('modal-title');
        const modalBody = document.getElementById('modal-body');
        
        function closeModal() {
            modal.classList.remove('active');
            // Cleanup Logic
            document.onkeydown = null;
            modalBody.innerHTML = '';
        }

        function openTest(type) {
            modal.classList.add('active');
            modalBody.innerHTML = ''; // Clear previous

            if (type === 'keyboard') {
                modalTitle.textContent = "Keyboard Tester";
                modalBody.innerHTML = `
                    <p>Press any key to see its code.</p>
                    <div class="test-display-area">
                        <div id="key-display" class="big-text">...</div>
                        <div id="code-display" class="med-text">Waiting for input</div>
                    </div>
                    <p style="font-size:0.8em; color: var(--text-secondary)">Press ESC to close.</p>
                `;
                document.onkeydown = function(e) {
                    if (e.key === 'Escape') { closeModal(); return; }
                    e.preventDefault();
                    document.getElementById('key-display').textContent = e.key;
                    document.getElementById('code-display').textContent = `Code: ${e.code}`;
                };
            } 
            else if (type === 'scroll') {
                modalTitle.textContent = "Scroll Speed Test";
                modalBody.innerHTML = `
                    <p>Scroll up and down inside the box below!</p>
                    <div class="test-display-area" style="height: auto;">
                        <div id="scroll-speed" class="big-text">0 px/s</div>
                    </div>
                    <div class="scroll-track" id="scroll-track">
                        <div class="scroll-content"></div>
                    </div>
                `;
                
                const track = document.getElementById('scroll-track');
                let lastScrollPos = track.scrollTop;
                let lastTime = Date.now();
                
                track.onscroll = () => {
                    const now = Date.now();
                    const currentScroll = track.scrollTop;
                    const deltaT = now - lastTime;
                    
                    if (deltaT > 50) { // Update every 50ms
                        const distance = Math.abs(currentScroll - lastScrollPos);
                        const speed = Math.round((distance / deltaT) * 1000);
                        document.getElementById('scroll-speed').textContent = `${speed} px/s`;
                        
                        lastScrollPos = currentScroll;
                        lastTime = now;
                    }
                };
            }
            else if (type === 'stress') {
                modalTitle.textContent = "CPU Stress Test";
                modalBody.innerHTML = `
                    <p>This will run heavy calculations for 5 seconds.</p>
                    <div class="test-display-area">
                        <div id="modal-fps-display" class="big-text">-- FPS</div>
                        <div id="stress-status" class="med-text">Ready?</div>
                    </div>
                    <button class="tool-btn" style="margin: 0 auto;" onclick="runStressTest()">Start Stress Test</button>
                `;
            }
            else if (type === 'cps') {
                // FIX: Reset state when opening the test to prevent glitches if reopening
                clicks = 0;
                cpsActive = false;
                if (typeof cpsTimeout !== 'undefined') clearTimeout(cpsTimeout);

                modalTitle.textContent = "CPS Test (5s)";
                modalBody.innerHTML = `
                    <div class="test-display-area" style="cursor:pointer; user-select: none; -webkit-user-select: none;" id="click-area" onclick="countClick()">
                        <div id="click-status" class="med-text">Click to Start!</div>
                        <div id="click-count" class="big-text">0</div>
                    </div>
                    <button class="tool-btn" style="margin: 10px auto 0;" onclick="resetCPS()">Restart Test</button>
                `;
            }
        }

        // Stress Test Implementation
        function runStressTest() {
            const status = document.getElementById('stress-status');
            const fpsDisplay = document.getElementById('modal-fps-display');
            status.textContent = "Stressing CPU...";
            
            const start = Date.now();
            const duration = 5000;
            
            // Sync FPS from the main background counter to the modal
            const fpsSync = setInterval(() => {
                const mainFps = document.getElementById('fps-value').textContent;
                if(fpsDisplay) fpsDisplay.textContent = mainFps;
            }, 100);

            function heavyLoad() {
                if (Date.now() - start > duration) {
                    status.textContent = "Done!";
                    clearInterval(fpsSync);
                    return;
                }
                
                // Mathematical load
                const arr = [];
                for(let i=0; i<100000; i++) {
                    arr.push(Math.sqrt(Math.random() * i));
                }
                arr.sort();
                
                requestAnimationFrame(heavyLoad);
            }
            heavyLoad();
        }

        // CPS Implementation
        let clicks = 0;
        let cpsActive = false;
        let cpsTimeout;
        
        function countClick() {
            if (!cpsActive && clicks === 0) {
                cpsActive = true;
                document.getElementById('click-status').textContent = "GO GO GO!";
                
                cpsTimeout = setTimeout(() => {
                    cpsActive = false;
                    const cps = clicks / 5;
                    document.getElementById('click-status').textContent = `Time's up! Speed: ${cps} CPS`;
                    document.getElementById('click-area').onclick = null; // Disable further clicks
                }, 5000);
            }
            
            if (cpsActive) {
                clicks++;
                document.getElementById('click-count').textContent = clicks;
            }
        }

        function resetCPS() {
            clearTimeout(cpsTimeout);
            clicks = 0;
            cpsActive = false;
            const clickArea = document.getElementById('click-area');
            if (clickArea) {
                clickArea.onclick = countClick;
                document.getElementById('click-status').textContent = "Click to Start!";
                document.getElementById('click-count').textContent = "0";
            }
        }

        // --- Initialization ---
        document.addEventListener('DOMContentLoaded', () => {
            // Seed chart data
            chartData.labels.push('INP');
            chartData.timing.push(0); 

            measurePaintAndLoadMetrics();
            measureInteractionMetrics();
            measureFPS(); 
            measurePing(); 
            
            runLocalStorageTest();
            runWasmSupportTest();
            
            // Start Timer
            benchmarkTimer = setTimeout(finalizeBenchmark, 7000);
        });
    </script>
</body>
</html>
