<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>StarlightGG Public Chat</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        .custom-scrollbar::-webkit-scrollbar { width: 4px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        body { background-color: #e0e5ec; }
        
        /* Animations */
        .animate-pop { animation: pop 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        @keyframes pop {
            0% { transform: scale(0.9); opacity: 0; }
            100% { transform: scale(1); opacity: 1; }
        }
        
        .animate-slide-in { animation: slideIn 0.3s ease-out forwards; }
        @keyframes slideIn {
            0% { transform: translateY(-20px); opacity: 0; }
            100% { transform: translateY(0); opacity: 1; }
        }

        .highlight-msg { animation: highlight 1s ease-in-out; }
        @keyframes highlight {
            0%, 100% { background-color: white; }
            50% { background-color: #e0e7ff; }
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef, useMemo } = React;

        // --- CONFIGURATION ---
        const NPOINT_ID = '91a6a6462f90e2065d0b'; 
        const API_URL = `https://api.npoint.io/${NPOINT_ID}`;
        const ADMIN_PASS = "admin$_0nly";

        const Icon = ({ name, size = 20, className = "" }) => {
            const iconRef = useRef(null);
            useEffect(() => {
                if (window.lucide && iconRef.current) {
                    iconRef.current.innerHTML = '';
                    const iconElement = document.createElement('i');
                    iconElement.setAttribute('data-lucide', name.toLowerCase().replace(/([a-z])([A-Z])/g, '$1-$2'));
                    iconElement.style.width = `${size}px`;
                    iconElement.style.height = `${size}px`;
                    if (className) iconElement.className = className;
                    iconRef.current.appendChild(iconElement);
                    window.lucide.createIcons({
                        attrs: { width: size, height: size, class: className },
                        nameAttr: 'data-lucide'
                    });
                }
            }, [name, size, className]);
            return <span ref={iconRef} className="inline-flex items-center justify-center"></span>;
        };

        function App() {
            const [username, setUsername] = useState('');
            const [password, setPassword] = useState('');
            const [isLoggedIn, setIsLoggedIn] = useState(false);
            const [isAdmin, setIsAdmin] = useState(false);
            
            // Cloud Sync States
            const [messages, setMessages] = useState([]);
            const [presence, setPresence] = useState({});
            const [globalMutes, setGlobalMutes] = useState([]);

            // UI States
            const [inputText, setInputText] = useState('');
            const [activeTab, setActiveTab] = useState('public');
            const [dmTarget, setDmTarget] = useState(null);
            const [showSidebar, setShowSidebar] = useState(false);
            const [selectedUserMenu, setSelectedUserMenu] = useState(null);
            const [replyTo, setReplyTo] = useState(null);
            const [showEmojiPicker, setShowEmojiPicker] = useState(false);
            const [mutedPublicUids, setMutedPublicUids] = useState(new Set());
            const [showClearConfirm, setShowClearConfirm] = useState(false);
            
            // Lock States
            const [isSending, setIsSending] = useState(false); 
            const [isSavingEdit, setIsSavingEdit] = useState(false);
            
            // Notifications (Toasts)
            const [toasts, setToasts] = useState([]);

            // Edit State
            const [editingId, setEditingId] = useState(null);
            const [editText, setEditText] = useState("");

            // Reaction Hover State
            const [hoveredReactionId, setHoveredReactionId] = useState(null);
            const [reactionMenuPos, setReactionMenuPos] = useState({ x: 0, y: 0 });

            // Reaction Menu State (Click)
            const [activeReactionId, setActiveReactionId] = useState(null);

            // Sync Lock
            const isSyncing = useRef(false);

            const scrollRef = useRef(null);
            const chatContainerRef = useRef(null);
            const fileInputRef = useRef(null);
            const lastDataStr = useRef(""); 
            
            const myUid = useMemo(() => `u-${Math.random().toString(36).substr(2, 9)}`, []);
            const QUICK_REACTS = ["ðŸ˜‚", "â¤ï¸", "ðŸ”¥", "ðŸ‘", "ðŸ’€", "ðŸ˜­", "ðŸ‘€", "ðŸ¤¡"];
            const FULL_EMOJI_LIST = ["ðŸ˜€", "ðŸ˜ƒ", "ðŸ˜„", "ðŸ˜", "ðŸ˜†", "ðŸ˜…", "ðŸ¤£", "ðŸ˜‚", "ðŸ™‚", "ðŸ™ƒ", "ðŸ˜‰", "ðŸ˜Š", "ðŸ˜‡", "ðŸ¥°", "ðŸ˜", "ðŸ¤©", "ðŸ˜˜", "ðŸ˜—", "ðŸ˜š", "ðŸ˜™", "ðŸ˜‹", "ðŸ˜›", "ðŸ˜œ", "ðŸ¤ª", "ðŸ˜", "ðŸ¤‘", "ðŸ¤—", "ðŸ¤­", "ðŸ¤«", "ðŸ¤”", "ðŸ¤", "ðŸ¤¨", "ðŸ˜", "ðŸ˜‘", "ðŸ˜¶", "ðŸ˜", "ðŸ˜’", "ðŸ™„", "ðŸ˜¬", "ðŸ¤¥", "ðŸ˜Œ", "ðŸ˜”", "ðŸ˜ª", "ðŸ¤¤", "ðŸ˜´", "ðŸ˜·", "ðŸ¤’", "ðŸ¤•", "ðŸ¤¢", "ðŸ¤®", "ðŸ¤§", "ðŸ¥µ", "ðŸ¥¶", "ðŸ¥´", "ðŸ˜µ", "ðŸ¤¯", "ðŸ¤ ", "ðŸ¥³", "ðŸ˜Ž", "ðŸ¤“", "ðŸ§", "ðŸ˜•", "ðŸ˜Ÿ", "ðŸ™", "â˜¹ï¸", "ðŸ˜®", "ðŸ˜¯", "ðŸ˜²", "ðŸ˜³", "ðŸ¥º", "ðŸ˜¦", "ðŸ˜§", "ðŸ˜¨", "ðŸ˜°", "ðŸ˜¥", "ðŸ˜¢", "ðŸ˜­", "ðŸ˜±", "ðŸ˜–", "ðŸ˜£", "ðŸ˜ž", "ðŸ˜“", "ðŸ˜©", "ðŸ˜«", "ðŸ¥±", "ðŸ˜¤", "ðŸ˜¡", "ðŸ˜ ", "ðŸ¤¬", "ðŸ˜ˆ", "ðŸ‘¿", "ðŸ’€", "â˜ ï¸", "ðŸ’©", "ðŸ¤¡", "ðŸ‘¹", "ðŸ‘º", "ðŸ‘»", "ðŸ‘½", "ðŸ‘¾", "ðŸ¤–", "ðŸ˜º", "ðŸ˜¸", "ðŸ˜»", "ðŸ˜¼", "ðŸ˜½", "ðŸ™€", "ðŸ˜¿", "ðŸ˜¾", "ðŸ™ˆ", "ðŸ™‰", "ðŸ™Š", "ðŸ’‹", "ðŸ’Œ", "ðŸ’˜", "ðŸ’", "ðŸ’–", "ðŸ’—", "ðŸ’“", "ðŸ’ž", "ðŸ’•", "ðŸ’Ÿ", "â£ï¸", "ðŸ’”", "â¤ï¸", "ðŸ§¡", "ðŸ’›", "ðŸ’š", "ðŸ’™", "ðŸ’œ", "ðŸ–¤", "ðŸ¤", "ðŸ¤Ž", "ðŸ’¯", "ðŸ’¢", "ðŸ’¥", "ðŸ’«", "ðŸ’¦", "ðŸ’¨", "ðŸ•³ï¸", "ðŸ’£", "ðŸ’¬", "ðŸ‘ï¸â€ðŸ—¨ï¸", "ðŸ—¨ï¸", "ðŸ—¯ï¸", "ðŸ’­", "ðŸ’¤"];

            // --- TOAST SYSTEM ---
            const addToast = (msg, type = 'info') => {
                const id = Date.now();
                setToasts(prev => [...prev, { id, msg, type }]);
                setTimeout(() => {
                    setToasts(prev => prev.filter(t => t.id !== id));
                }, 3000);
            };

            // --- SYNC ENGINE ---
            const fetchData = async () => {
                try {
                    const res = await fetch(API_URL);
                    const data = await res.json();
                    if (data) {
                        const currentStr = JSON.stringify(data.messages);
                        if (currentStr !== lastDataStr.current) {
                            if (Array.isArray(data.messages)) setMessages(data.messages);
                            lastDataStr.current = currentStr;
                        }
                        if (data.presence) setPresence(data.presence);
                        if (Array.isArray(data.globalMutes)) setGlobalMutes(data.globalMutes);
                    }
                } catch (e) { console.error("Sync Error", e); }
            };

            const pushUpdate = async (updates) => {
                isSyncing.current = true;
                try {
                    const res = await fetch(API_URL);
                    const current = await res.json();
                    
                    let nextMessages;
                    if (updates.messages !== undefined) {
                        nextMessages = updates.messages;
                    } else {
                        nextMessages = current.messages || [];
                    }

                    const payload = {
                        messages: nextMessages,
                        presence: { ...(current.presence || {}), ...(updates.presence || {}) },
                        globalMutes: updates.globalMutes !== undefined ? updates.globalMutes : (current.globalMutes || [])
                    };
                    
                    await fetch(API_URL, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });
                } catch (e) { console.error("Push Error", e); addToast("Sync Failed", "error"); }
                finally {
                    isSyncing.current = false;
                }
            };

            useEffect(() => {
                if (isLoggedIn) {
                    fetchData();
                    const interval = setInterval(() => {
                        if (!isSyncing.current) {
                            fetchData();
                            pushUpdate({ 
                                presence: { [myUid]: { name: username, lastSeen: Date.now(), isAdmin } } 
                            });
                        }
                    }, 3000); 
                    return () => clearInterval(interval);
                }
            }, [isLoggedIn]);

            useEffect(() => {
                const container = chatContainerRef.current;
                if (container) {
                    const isAtBottom = container.scrollHeight - container.scrollTop <= container.clientHeight + 150;
                    if (isAtBottom) scrollRef.current?.scrollIntoView({ behavior: 'smooth' });
                }
            }, [messages]);

            // --- HANDLERS ---
            const handleLogin = () => {
                if (!username.trim()) return addToast("Please enter a nickname", "error");
                const lower = username.toLowerCase();
                const needsPass = lower.includes("[admin]") || lower.includes("[owner]");
                if (needsPass && password !== ADMIN_PASS) return addToast("Invalid Admin Key", "error");
                if (needsPass) setIsAdmin(true);
                setIsLoggedIn(true);
                addToast(`Welcome, ${username}!`, "success");
            };

            const scrollToMessage = (id) => {
                const el = document.getElementById(`msg-${id}`);
                if (el) {
                    el.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    el.classList.add('bg-indigo-100');
                    setTimeout(() => el.classList.remove('bg-indigo-100'), 1500);
                }
            };

            const sendMessage = async (imgData = null) => {
                if ((!inputText.trim() && !imgData) || globalMutes.includes(myUid) || isSending) return;
                
                setIsSending(true); // LOCK INPUT
                isSyncing.current = true;
                
                const newMsg = {
                    id: Date.now() + Math.random(),
                    text: imgData || inputText,
                    userName: username,
                    uid: myUid,
                    isAdmin,
                    timestamp: new Date().toISOString(),
                    type: imgData ? 'image' : 'text',
                    reacts: {},
                    replyTo: replyTo ? { id: replyTo.id, text: replyTo.text, user: replyTo.userName } : null,
                    isDM: activeTab === 'dm',
                    targetUid: activeTab === 'dm' ? dmTarget?.uid : null
                };

                setMessages(prev => {
                   const updated = [...prev, newMsg].slice(-100);
                   lastDataStr.current = JSON.stringify(updated); 
                   return updated;
                });
                setInputText('');
                setReplyTo(null);
                setShowEmojiPicker(false);
                scrollRef.current?.scrollIntoView({ behavior: 'smooth' });

                try {
                    const res = await fetch(API_URL);
                    const current = await res.json();
                    const currentMessages = Array.isArray(current.messages) ? current.messages : [];
                    const updatedMessages = [...currentMessages, newMsg].slice(-100);
                    await fetch(API_URL, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ ...current, messages: updatedMessages })
                    });
                } catch (e) { 
                    addToast("Failed to send message", "error"); 
                } finally {
                    isSyncing.current = false;
                    setIsSending(false); // UNLOCK INPUT
                }
            };

            const handleEdit = async (msgId) => {
                if (!editText.trim() || isSavingEdit) return; // Locked
                
                setIsSavingEdit(true); // Lock Edit UI
                
                const updatedMsgs = messages.map(m => m.id === msgId ? { ...m, text: editText, isEdited: true } : m);
                
                // Optimistic UI update
                setMessages(updatedMsgs);
                lastDataStr.current = JSON.stringify(updatedMsgs);
                
                try {
                    await pushUpdate({ messages: updatedMsgs });
                    setEditingId(null); // Close on success
                    setEditText("");
                    addToast("Message edited", "info");
                } catch (e) {
                    addToast("Failed to edit message", "error");
                } finally {
                    setIsSavingEdit(false); // Unlock
                }
            };

            const startEditing = (msg) => {
                setEditingId(msg.id);
                setEditText(msg.text);
            };

            const deleteMessage = async (id) => {
                const updated = messages.filter(m => m.id !== id);
                setMessages(updated);
                lastDataStr.current = JSON.stringify(updated);
                addToast("Message deleted", "info");
                await pushUpdate({ messages: updated });
            };

            const confirmClearChat = async () => {
                setShowClearConfirm(false);
                setMessages([]);
                lastDataStr.current = JSON.stringify([]);
                addToast("Clearing chat...", "info");

                isSyncing.current = true;
                try {
                    const res = await fetch(API_URL);
                    const current = await res.json();
                    const payload = { ...current, messages: [] };
                    await fetch(API_URL, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });
                    addToast("Chat cleared successfully", "success");
                } catch (e) {
                    addToast("Failed to clear chat", "error");
                    console.error(e);
                } finally {
                    isSyncing.current = false;
                }
            };

            const toggleGlobalMute = async (targetUid) => {
                const updated = globalMutes.includes(targetUid) 
                    ? globalMutes.filter(id => id !== targetUid) : [...globalMutes, targetUid];
                setGlobalMutes(updated);
                addToast(updated.includes(targetUid) ? "User Muted" : "User Unmuted", "info");
                await pushUpdate({ globalMutes: updated });
            };

            const toggleReact = async (msgId, emoji) => {
                const updated = messages.map(m => {
                    if (m.id !== msgId) return m;
                    const reacts = { ...m.reacts };
                    const uids = reacts[emoji] || [];
                    reacts[emoji] = uids.includes(myUid) ? uids.filter(id => id !== myUid) : [...uids, myUid];
                    return { ...m, reacts };
                });
                setMessages(updated);
                lastDataStr.current = JSON.stringify(updated);
                setActiveReactionId(null);
                await pushUpdate({ messages: updated });
            };
            
            const handleReactionClick = (e, msgId) => {
                if (activeReactionId === msgId) {
                    setActiveReactionId(null);
                    return;
                }

                const rect = e.currentTarget.getBoundingClientRect();
                const menuWidth = 320; 
                
                let x = rect.left + (rect.width / 2) - (menuWidth / 2);
                if (x < 10) x = 10;
                if (x + menuWidth > window.innerWidth - 10) {
                    x = window.innerWidth - menuWidth - 10;
                }

                setReactionMenuPos({ x, y: rect.top - 55 });
                setActiveReactionId(msgId);
            };

            const onlineUsers = useMemo(() => {
                const now = Date.now();
                return Object.entries(presence)
                    .filter(([uid, data]) => now - data.lastSeen < 12000)
                    .map(([uid, data]) => ({ uid, ...data }));
            }, [presence]);

            if (!isLoggedIn) {
                return (
                    <div className="h-screen flex items-center justify-center p-4">
                        <div className="fixed top-4 left-0 right-0 z-50 flex flex-col items-center gap-2 pointer-events-none">
                            {toasts.map(t => (
                                <div key={t.id} className={`px-4 py-2 rounded-full shadow-lg text-sm font-bold text-white animate-slide-in pointer-events-auto ${t.type === 'error' ? 'bg-red-500' : t.type === 'success' ? 'bg-green-500' : 'bg-indigo-500'}`}>
                                    {t.msg}
                                </div>
                            ))}
                        </div>
                        <div className="w-full max-w-sm p-10 rounded-[40px] bg-[#e0e5ec] shadow-[20px_20px_60px_#bec8d4,-20px_-20px_60px_#ffffff] text-center">
                            <div className="flex justify-center mb-6 text-amber-400"><Icon name="Crown" size={48} /></div>
                            <h1 className="text-2xl font-black text-indigo-600 mb-8 uppercase tracking-tighter">Starlight Chat</h1>
                            <div className="space-y-4">
                                <input className="w-full p-4 rounded-xl bg-[#e0e5ec] shadow-[inset_4px_4px_8px_#bec8d4,inset_-4px_-4px_8px_#ffffff] outline-none text-center font-bold text-indigo-600" placeholder="Nickname" value={username} onChange={(e) => setUsername(e.target.value)} />
                                {(username.toLowerCase().includes("[admin]") || username.toLowerCase().includes("[owner]")) && (
                                    <input type="password" className="w-full p-4 rounded-xl bg-[#e0e5ec] shadow-[inset_4px_4px_8px_#bec8d4,inset_-4px_-4px_8px_#ffffff] outline-none text-center font-bold text-indigo-600" placeholder="Admin Key" value={password} onChange={(e) => setPassword(e.target.value)} />
                                )}
                                <button onClick={handleLogin} className="w-full p-4 rounded-xl bg-indigo-600 text-white font-black uppercase active:scale-95 transition-all">Join Orbit</button>
                            </div>
                        </div>
                    </div>
                );
            }

            return (
                <div className="h-screen w-full flex p-4 gap-4 overflow-hidden relative">
                    {/* Clear Chat Modal */}
                    {showClearConfirm && (
                        <>
                            <div className="fixed inset-0 bg-black/50 z-[60] backdrop-blur-sm" onClick={() => setShowClearConfirm(false)} />
                            <div className="fixed top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 z-[70] bg-white p-6 rounded-[32px] shadow-2xl w-80 text-center animate-pop">
                                <div className="text-red-500 flex justify-center mb-4"><Icon name="AlertTriangle" size={48} /></div>
                                <h3 className="text-xl font-black text-slate-800 mb-2">CLEAR ALL MESSAGES?</h3>
                                <p className="text-sm text-slate-500 mb-6 font-medium">This will wipe the chat history for everyone. This action cannot be undone.</p>
                                <div className="flex gap-3">
                                    <button onClick={() => setShowClearConfirm(false)} className="flex-1 py-3 rounded-xl bg-slate-100 font-bold text-slate-500 hover:bg-slate-200">Cancel</button>
                                    <button onClick={confirmClearChat} className="flex-1 py-3 rounded-xl bg-red-500 font-bold text-white hover:bg-red-600 shadow-lg shadow-red-500/30">Wipe It</button>
                                </div>
                            </div>
                        </>
                    )}

                    {/* Fixed Reaction Menu with Backdrop */}
                    {activeReactionId && (
                        <>
                            {/* Transparent Backdrop to detect click-off */}
                            <div 
                                className="fixed inset-0 z-40" 
                                onClick={() => setActiveReactionId(null)}
                            />
                            {/* Menu */}
                            <div 
                                className="fixed z-50 bg-white p-2 rounded-2xl shadow-2xl flex gap-1 animate-pop border border-slate-100 items-center" 
                                style={{ top: reactionMenuPos.y, left: reactionMenuPos.x }}
                            >
                                {QUICK_REACTS.map(emoji => (
                                    <button key={emoji} onClick={() => toggleReact(activeReactionId, emoji)} className="hover:scale-125 transition-transform px-1 text-xl">{emoji}</button>
                                ))}
                            </div>
                        </>
                    )}

                    {/* Toast Container */}
                    <div className="fixed top-4 left-0 right-0 z-50 flex flex-col items-center gap-2 pointer-events-none">
                        {toasts.map(t => (
                            <div key={t.id} className={`px-6 py-2 rounded-2xl shadow-xl text-sm font-bold text-white animate-slide-in pointer-events-auto flex items-center gap-2 ${t.type === 'error' ? 'bg-red-500' : t.type === 'success' ? 'bg-green-500' : 'bg-indigo-500'}`}>
                                {t.type === 'error' && <Icon name="AlertCircle" size={16}/>}
                                {t.type === 'success' && <Icon name="CheckCircle" size={16}/>}
                                {t.msg}
                            </div>
                        ))}
                    </div>

                    {/* Sidebar */}
                    <div className={`${showSidebar ? 'fixed inset-4 z-50 flex' : 'hidden'} lg:flex lg:relative w-72 flex-col rounded-[32px] bg-[#e0e5ec] shadow-[12px_12px_24px_#bec8d4,-12px_-12px_24px_#ffffff] p-6`}>
                        <div className="flex items-center justify-between mb-6">
                            <h2 className="font-black text-[10px] uppercase text-slate-400 tracking-widest">Global Citizens ({onlineUsers.length})</h2>
                            <button onClick={() => setShowSidebar(false)} className="lg:hidden"><Icon name="X" size={18}/></button>
                        </div>
                        <div onClick={() => { setActiveTab('public'); setDmTarget(null); setShowSidebar(false); }} className={`p-4 rounded-2xl cursor-pointer mb-6 flex items-center gap-3 transition-all ${activeTab === 'public' ? 'bg-indigo-600 text-white shadow-lg' : 'shadow-inner'}`}>
                            <Icon name="Globe" size={18} />
                            <span className="text-xs font-black uppercase">Public Galaxy</span>
                        </div>
                        
                        {/* Admin Controls in Sidebar */}
                        {isAdmin && (
                            <div className="mb-6 p-4 rounded-2xl bg-red-50 border border-red-100">
                                <h3 className="text-[10px] font-black uppercase text-red-400 mb-2">Admin Zone</h3>
                                <button onClick={() => setShowClearConfirm(true)} className="w-full py-2 px-3 bg-red-500 text-white rounded-xl text-xs font-bold hover:bg-red-600 transition-all flex items-center justify-center gap-2">
                                    <Icon name="Trash2" size={14}/> Clear Global Chat
                                </button>
                            </div>
                        )}

                        <div className="flex-1 overflow-y-auto space-y-3 custom-scrollbar pr-2">
                            {onlineUsers.map(u => (
                                <div key={u.uid} className="relative group">
                                    <div onClick={() => setSelectedUserMenu(selectedUserMenu === u.uid ? null : u.uid)} className={`p-3 rounded-2xl cursor-pointer flex items-center gap-3 transition-all hover:bg-white/40`}>
                                        <div className={`w-8 h-8 rounded-lg flex items-center justify-center ${u.isAdmin ? 'bg-amber-100 text-amber-500' : 'bg-indigo-100 text-indigo-500'}`}>
                                            {u.isAdmin ? <Icon name="Crown" size={14} /> : <div className="w-2 h-2 rounded-full bg-green-400 animate-pulse" />}
                                        </div>
                                        <span className={`text-xs font-bold truncate flex-1 ${globalMutes.includes(u.uid) || mutedPublicUids.has(u.uid) ? 'line-through opacity-50' : ''}`}>
                                            {u.name} {u.uid === myUid && <span className="text-[10px] text-indigo-400">(You)</span>}
                                        </span>
                                    </div>
                                    {selectedUserMenu === u.uid && u.uid !== myUid && (
                                        <div className="absolute left-0 right-0 top-full mt-2 z-50 bg-white rounded-2xl shadow-2xl p-2 animate-pop">
                                            <button onClick={() => { setDmTarget(u); setActiveTab('dm'); setSelectedUserMenu(null); }} className="w-full p-2 text-left text-[10px] font-black uppercase text-indigo-600 hover:bg-indigo-50 rounded-xl flex items-center gap-3"><Icon name="MessageSquare" size={14} /> DM</button>
                                            <button onClick={() => { const s = new Set(mutedPublicUids); s.has(u.uid) ? s.delete(u.uid) : s.add(u.uid); setMutedPublicUids(s); setSelectedUserMenu(null); addToast(s.has(u.uid) ? "User muted locally" : "User unmuted locally"); }} className="w-full p-2 text-left text-[10px] font-black uppercase text-orange-500 hover:bg-orange-50 rounded-xl flex items-center gap-3"><Icon name="UserX" size={14} /> Local Mute</button>
                                            {isAdmin && (
                                                <button onClick={() => { toggleGlobalMute(u.uid); setSelectedUserMenu(null); }} className="w-full p-2 text-left text-[10px] font-black uppercase text-red-600 hover:bg-red-50 rounded-xl flex items-center gap-3">
                                                    <Icon name={globalMutes.includes(u.uid) ? "Mic" : "MicOff"} size={14} /> {globalMutes.includes(u.uid) ? "Global Unmute" : "Global Mute"}
                                                </button>
                                            )}
                                        </div>
                                    )}
                                </div>
                            ))}
                        </div>
                    </div>

                    {/* Chat Area */}
                    <div className="flex-1 flex flex-col rounded-[32px] bg-[#e0e5ec] shadow-[12px_12px_24px_#bec8d4,-12px_-12px_24px_#ffffff] overflow-hidden">
                        <div className="p-5 border-b border-white/20 flex justify-between items-center bg-white/10 backdrop-blur-sm">
                            <div className="flex items-center gap-3">
                                <button onClick={() => setShowSidebar(true)} className="lg:hidden p-2 rounded-xl shadow-md bg-[#e0e5ec] text-indigo-600"><Icon name="Users" size={18}/></button>
                                <div>
                                    <h2 className="text-xs font-black uppercase text-slate-400 tracking-wider">{activeTab === 'public' ? 'Public Galaxy' : 'Private Transmission'}</h2>
                                    {activeTab === 'dm' && <p className="text-xs font-bold text-indigo-600">{dmTarget?.name}</p>}
                                </div>
                            </div>
                        </div>

                        <div ref={chatContainerRef} className="flex-1 overflow-y-auto p-6 space-y-6 custom-scrollbar">
                            {messages
                                .filter(m => !globalMutes.includes(m.uid))
                                .filter(m => activeTab === 'public' ? (!m.isDM && !mutedPublicUids.has(m.uid)) : (m.isDM && (m.uid === dmTarget?.uid || m.uid === myUid)))
                                .map((m) => (
                                    <div key={m.id} id={`msg-${m.id}`} className={`flex flex-col ${m.uid === myUid ? 'items-end' : 'items-start'} group animate-pop transition-all`}>
                                        <div className="flex items-center gap-2 mb-1 px-1">
                                            <span className={`text-[9px] font-black uppercase tracking-wider ${m.isAdmin ? 'text-amber-500' : 'text-indigo-400'}`}>{m.userName}</span>
                                            {/* Action Buttons */}
                                            <div className="flex items-center gap-1 opacity-100 transition-opacity">
                                                <button onClick={() => setReplyTo(m)} className="p-1 hover:bg-white/50 rounded" title="Reply"><Icon name="Reply" size={12} className="text-slate-400" /></button>
                                                {m.uid === myUid && !m.isDM && (
                                                    <button onClick={() => startEditing(m)} className="p-1 hover:bg-white/50 rounded" title="Edit"><Icon name="Pencil" size={12} className="text-indigo-400" /></button>
                                                )}
                                                {(isAdmin || m.uid === myUid) && (
                                                    <button onClick={() => deleteMessage(m.id)} className="p-1 hover:bg-white/50 rounded" title="Delete"><Icon name="Trash2" size={12} className="text-red-400" /></button>
                                                )}
                                                
                                                {/* Click Reaction Trigger */}
                                                <button 
                                                    onClick={(e) => handleReactionClick(e, m.id)}
                                                    className={`p-1 hover:bg-white/50 rounded cursor-pointer ${activeReactionId === m.id ? 'text-amber-500 bg-amber-50' : 'text-slate-400 hover:text-amber-500'}`}
                                                    title="React"
                                                >
                                                    <Icon name="Smile" size={12}/>
                                                </button>
                                            </div>
                                        </div>
                                        
                                        {m.replyTo && (
                                            <div onClick={() => m.replyTo.id && scrollToMessage(m.replyTo.id)} className={`text-[10px] bg-white/30 px-3 py-1 rounded-t-xl border-l-2 border-indigo-400 mb-[-8px] opacity-70 italic max-w-[70%] truncate cursor-pointer hover:opacity-100 transition-opacity`}>
                                                @{m.replyTo.user}: {m.replyTo.text}
                                            </div>
                                        )}

                                        <div className={`p-4 rounded-2xl shadow-md max-w-[85%] relative ${m.uid === myUid ? 'bg-indigo-600 text-white rounded-tr-none' : 'bg-white text-slate-700 rounded-tl-none'}`}>
                                            {editingId === m.id ? (
                                                <div className="flex gap-2 min-w-[200px]">
                                                    <input 
                                                        autoFocus 
                                                        className="flex-1 bg-white/20 rounded px-2 py-1 text-inherit outline-none border border-white/30 disabled:opacity-50" 
                                                        value={editText} 
                                                        disabled={isSavingEdit}
                                                        onChange={(e) => setEditText(e.target.value)} 
                                                        onKeyDown={e => e.key === 'Enter' && handleEdit(m.id)} 
                                                    />
                                                    <button 
                                                        onClick={() => handleEdit(m.id)} 
                                                        disabled={isSavingEdit}
                                                        className="text-xs font-bold bg-white/20 px-2 rounded hover:bg-white/40 disabled:cursor-not-allowed"
                                                    >
                                                        {isSavingEdit ? "Saving..." : "Save"}
                                                    </button>
                                                    <button 
                                                        onClick={() => setEditingId(null)} 
                                                        disabled={isSavingEdit}
                                                        className="text-xs bg-red-500/50 px-2 rounded hover:bg-red-500/70 disabled:cursor-not-allowed"
                                                    >
                                                        X
                                                    </button>
                                                </div>
                                            ) : (
                                                <>
                                                    {m.type === 'image' ? <img src={m.text} className="max-h-60 rounded-lg" /> : <p className="text-sm font-medium leading-relaxed whitespace-pre-wrap">{m.text}</p>}
                                                    {m.isEdited && <span className="text-[9px] opacity-60 ml-2 italic">(edited)</span>}
                                                </>
                                            )}
                                            
                                            {Object.keys(m.reacts || {}).length > 0 && (
                                                <div className="mt-2 flex flex-wrap gap-1">
                                                    {Object.entries(m.reacts).map(([emoji, uids]) => uids.length > 0 && (
                                                        <button key={emoji} onClick={() => toggleReact(m.id, emoji)} className={`text-[10px] px-2 py-0.5 rounded-full shadow-sm flex items-center gap-1 border ${uids.includes(myUid) ? 'bg-indigo-100 border-indigo-300 text-indigo-700' : 'bg-white/20 border-white/40'}`}>
                                                            {emoji} <span className="font-black">{uids.length}</span>
                                                        </button>
                                                    ))}
                                                </div>
                                            )}
                                        </div>
                                    </div>
                                ))}
                            <div ref={scrollRef} />
                        </div>

                        {/* Input */}
                        <div className="p-4 bg-white/10 border-t border-white/20 relative">
                            {showEmojiPicker && (
                                <div className="absolute bottom-full mb-4 left-4 right-4 bg-white/95 backdrop-blur-xl rounded-[32px] shadow-2xl p-5 z-50 animate-pop border border-white/50 max-h-64 overflow-y-auto custom-scrollbar">
                                    <div className="grid grid-cols-8 sm:grid-cols-12 gap-3">
                                        {FULL_EMOJI_LIST.map(e => <button key={e} onClick={() => { setInputText(prev => prev + e); setShowEmojiPicker(false); }} className="text-2xl hover:scale-150 transition-all p-1">{e}</button>)}
                                    </div>
                                </div>
                            )}
                            {replyTo && (
                                <div className="mb-3 p-3 bg-indigo-50 rounded-2xl flex items-center justify-between border-l-4 border-indigo-500 animate-pop">
                                    <div className="truncate pr-4"><span className="text-[10px] font-black uppercase text-indigo-500 block">Replying to {replyTo.userName}</span><span className="text-xs text-slate-500 italic truncate block">{replyTo.text}</span></div>
                                    <button onClick={() => setReplyTo(null)} className="p-2"><Icon name="X" size={14} className="text-slate-400" /></button>
                                </div>
                            )}
                            <div className="flex gap-3">
                                <div className="flex-1 flex bg-white/60 rounded-2xl shadow-inner px-4 py-2 items-center border border-white/30 backdrop-blur-sm">
                                    <button onClick={() => setShowEmojiPicker(!showEmojiPicker)} className={`p-2 ${showEmojiPicker ? 'text-indigo-600' : 'text-slate-400'}`}><Icon name="Smile" size={20}/></button>
                                    <input className="flex-1 bg-transparent outline-none px-3 text-sm font-bold text-slate-700 disabled:opacity-50 disabled:cursor-not-allowed" placeholder={globalMutes.includes(myUid) ? "You are globally muted." : (isSending ? "Sending..." : "Message the galaxy...")} value={inputText} disabled={globalMutes.includes(myUid) || isSending} onChange={(e) => setInputText(e.target.value)} onKeyDown={(e) => e.key === 'Enter' && sendMessage()} />
                                    <button onClick={() => fileInputRef.current?.click()} disabled={globalMutes.includes(myUid) || isSending} className="p-2 text-slate-400 hover:text-indigo-500 disabled:opacity-50 disabled:cursor-not-allowed"><Icon name="Image" size={20}/></button>
                                    <input type="file" ref={fileInputRef} className="hidden" accept="image/*" onChange={(e) => { const f = e.target.files[0]; if(f){ const r=new FileReader(); r.onload=(ev)=>sendMessage(ev.target.result); r.readAsDataURL(f); } }} />
                                </div>
                                <button onClick={() => sendMessage()} disabled={globalMutes.includes(myUid) || isSending} className="p-4 bg-indigo-600 text-white rounded-2xl shadow-xl active:scale-90 transition-all disabled:grayscale disabled:cursor-not-allowed"><Icon name="Send" size={20}/></button>
                            </div>
                        </div>
                    </div>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
